<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BLE Athena Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    h1 { color: #4ade80; }
    h3 { margin-top: 20px; margin-bottom: 10px; }
    button {
      background: #4ade80;
      color: #000;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }
    button:disabled { background: #666; color: #999; cursor: not-allowed; }
    button:hover:not(:disabled) { background: #22c55e; }
    .status {
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      background: #333;
    }
    .connected { background: #166534; }
    .disconnected { background: #7f1d1d; }
    .log {
      background: #000;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .response {
      background: #1e3a5f;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      margin: 10px 0;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 150px;
      overflow-y: auto;
    }
    .methods { margin: 20px 0; }
    .method-btn {
      background: #3b82f6;
      margin: 3px;
      padding: 8px 16px;
      font-size: 14px;
    }
    .method-btn:hover:not(:disabled) { background: #2563eb; }
    input[type="text"] {
      padding: 10px;
      border-radius: 4px;
      border: none;
      width: 200px;
      font-size: 14px;
    }
    .hint {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>BLE Athena</h1>

  <div class="status disconnected" id="status">
    Not connected
  </div>

  <div>
    <button id="reconnectBtn" onclick="reconnect()" style="display:none">Reconnect</button>
    <button id="connectBtn" onclick="connect()">New Device</button>
    <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
  </div>

  <div class="methods">
    <h3>Device Info</h3>
    <button class="method-btn" onclick="callMethod('getDongleId', {})" disabled>getDongleId</button>
    <button class="method-btn" onclick="callMethod('getVersion', {})" disabled>getVersion</button>
    <button class="method-btn" onclick="callMethod('getNetworkType', {})" disabled>getNetworkType</button>
  </div>

  <div class="methods">
    <h3>Params</h3>
    <button class="method-btn" onclick="callMethod('getGithubUsername', {})" disabled>getGithubUsername</button>
    <button class="method-btn" onclick="callMethod('getSimInfo', {})" disabled>getSimInfo</button>
    <br>
    <input type="text" id="paramKey" placeholder="param key" style="width:120px">
    <button class="method-btn" onclick="getParam()" disabled>getParam</button>
  </div>

  <div class="methods">
    <h3>Device Control</h3>
    <button class="method-btn" style="background:#ef4444" onclick="confirmReboot()" disabled>Reboot</button>
    <button class="method-btn" style="background:#ef4444" onclick="confirmShutdown()" disabled>Shutdown</button>
  </div>

  <h3>Response</h3>
  <div class="response" id="response">-</div>

  <h3>Log</h3>
  <div class="log" id="log"></div>

<script>
const SERVICE_UUID = 'a51a5a10-0001-4c0d-b8e6-a51a5a100001';
const RPC_REQUEST_UUID = 'a51a5a10-0002-4c0d-b8e6-a51a5a100001';
const RPC_RESPONSE_UUID = 'a51a5a10-0003-4c0d-b8e6-a51a5a100001';

let device = null;
let server = null;
let service = null;
let requestChar = null;
let responseChar = null;
let responseBuffer = '';
let requestId = 0;
let autoReconnect = true;

function log(msg) {
  const el = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  el.textContent = `[${time}] ${msg}\n` + el.textContent;
  console.log(msg);
}

function setStatus(connected, text) {
  const el = document.getElementById('status');
  el.textContent = text;
  el.className = 'status ' + (connected ? 'connected' : 'disconnected');

  document.getElementById('connectBtn').disabled = connected;
  document.getElementById('disconnectBtn').disabled = !connected;
  document.querySelectorAll('.method-btn').forEach(btn => btn.disabled = !connected);
}

async function updateReconnectButton() {
  const reconnectBtn = document.getElementById('reconnectBtn');
  if (!navigator.bluetooth.getDevices) {
    reconnectBtn.style.display = 'none';
    return;
  }

  const devices = await navigator.bluetooth.getDevices();
  const athenaDevice = devices.find(d => d.name?.startsWith('comma-'));

  if (athenaDevice && !device) {
    reconnectBtn.style.display = 'inline-block';
    reconnectBtn.textContent = `Reconnect (${athenaDevice.name})`;
  } else {
    reconnectBtn.style.display = 'none';
  }
}

async function reconnect() {
  try {
    const devices = await navigator.bluetooth.getDevices();
    const athenaDevice = devices.find(d => d.name?.startsWith('comma-'));

    if (!athenaDevice) {
      log('No paired device found, use New Device');
      return;
    }

    log(`Reconnecting to ${athenaDevice.name}...`);
    setStatus(false, 'Connecting...');

    device = athenaDevice;
    device.addEventListener('gattserverdisconnected', onDisconnected);

    await connectToDevice();
  } catch (error) {
    log(`Reconnect error: ${error.message}`);
    setStatus(false, 'Connection failed');
  }
}

async function connect() {
  try {
    log('Requesting BLE device...');

    device = await navigator.bluetooth.requestDevice({
      filters: [
        { services: [SERVICE_UUID] },
        { namePrefix: 'comma-' }
      ],
      optionalServices: [SERVICE_UUID]
    });

    log(`Found device: ${device.name}`);
    localStorage.setItem('ble_last_device', device.name);

    device.addEventListener('gattserverdisconnected', onDisconnected);

    await connectToDevice();

  } catch (error) {
    log(`Error: ${error.message}`);
    setStatus(false, 'Connection failed');
  }
}

async function connectToDevice() {
  try {
    log('Connecting to GATT server...');
    server = await device.gatt.connect();

    log('Getting Athena service...');
    service = await server.getPrimaryService(SERVICE_UUID);

    log('Getting characteristics...');
    requestChar = await service.getCharacteristic(RPC_REQUEST_UUID);
    responseChar = await service.getCharacteristic(RPC_RESPONSE_UUID);

    log('Starting notifications...');
    await responseChar.startNotifications();
    responseChar.addEventListener('characteristicvaluechanged', handleResponse);

    log('Connected!');
    setStatus(true, `Connected to ${device.name}`);
    updateReconnectButton();

    // Auto-fetch device info
    callMethod('getDongleId', {});

  } catch (error) {
    log(`Connection error: ${error.message}`);
    setStatus(false, 'Connection failed');
  }
}

function onDisconnected() {
  log('Device disconnected');
  setStatus(false, 'Disconnected');
  updateReconnectButton();

  // Auto-reconnect if enabled and device still exists
  if (autoReconnect && device) {
    log('Attempting to reconnect in 2s...');
    setTimeout(async () => {
      if (device && !device.gatt.connected) {
        try {
          await connectToDevice();
        } catch (e) {
          log(`Reconnect failed: ${e.message}`);
        }
      }
    }, 2000);
  }
}

async function disconnect() {
  autoReconnect = false;
  if (device && device.gatt.connected) {
    device.gatt.disconnect();
  }
  device = null;
  setStatus(false, 'Disconnected');
  updateReconnectButton();
  setTimeout(() => { autoReconnect = true; }, 1000);
}

function handleResponse(event) {
  const value = event.target.value;
  const decoder = new TextDecoder('utf-8');
  const chunk = decoder.decode(value);

  responseBuffer += chunk;

  try {
    const response = JSON.parse(responseBuffer);
    log(`Response received`);
    document.getElementById('response').textContent = JSON.stringify(response, null, 2);
    responseBuffer = '';
  } catch (e) {
    // Incomplete JSON, wait for more
  }
}

async function callMethod(method, params) {
  if (!requestChar) {
    log('Not connected');
    return;
  }

  requestId++;
  const request = {
    jsonrpc: '2.0',
    method: method,
    params: params,
    id: requestId
  };

  const json = JSON.stringify(request);
  log(`Calling ${method}...`);

  try {
    const encoder = new TextEncoder();
    const data = encoder.encode(json);

    const MTU = 512;
    for (let i = 0; i < data.length; i += MTU) {
      const chunk = data.slice(i, i + MTU);
      await requestChar.writeValue(chunk);
    }
  } catch (error) {
    log(`Error: ${error.message}`);
  }
}

function getParam() {
  const key = document.getElementById('paramKey').value.trim();
  if (key) {
    callMethod('getParam', { key });
  }
}

function confirmReboot() {
  if (confirm('Reboot device?')) {
    callMethod('reboot', {});
  }
}

function confirmShutdown() {
  if (confirm('Shutdown device?')) {
    callMethod('shutdown', {});
  }
}

// Init
if (!navigator.bluetooth) {
  log('Web Bluetooth not supported - use Chrome on desktop or Android');
  document.getElementById('status').textContent = 'Web Bluetooth not supported';
  document.getElementById('connectBtn').disabled = true;
} else {
  updateReconnectButton();
}
</script>
</body>
</html>
