#!/bin/bash
# asius-ssh-proxy - SSH proxy for Asius devices
# Usage: asius-ssh-proxy <dongle_id>
#
# Install:
#   curl -fsSL https://asius.ai/asius-ssh-proxy -o asius-ssh-proxy
#   chmod +x asius-ssh-proxy
#   sudo mv asius-ssh-proxy /usr/local/bin/
#
# Requires:
#   - websocat (https://github.com/vi/websocat)
#
# SSH config (~/.ssh/config):
#   Host asius-*
#     User comma
#     ProxyCommand asius-ssh-proxy %n
#     StrictHostKeyChecking no
#     UserKnownHostsFile /dev/null

set -e

# Extract dongle_id from hostname (asius-XXXXX -> XXXXX)
if [[ "$1" == asius-* ]]; then
  DONGLE_ID="${1#asius-}"
else
  DONGLE_ID="$1"
fi

API_URL="${ASIUS_API_URL:-wss://api.asius.ai}"

if [ -z "$DONGLE_ID" ]; then
  echo "Usage: asius-ssh-proxy <dongle_id>" >&2
  echo "       asius-ssh-proxy asius-<dongle_id>" >&2
  exit 1
fi

# Check for websocat
if ! command -v websocat &> /dev/null; then
  echo "Error: websocat is required but not installed" >&2
  echo "Install: brew install websocat (macOS) or download from github.com/vi/websocat" >&2
  exit 1
fi

# Connect directly to WebSocket relay
# No auth needed - SSH protocol handles authentication via GitHub keys on device
WS_URL="${API_URL}/ssh/${DONGLE_ID}"

exec websocat -b "$WS_URL"
